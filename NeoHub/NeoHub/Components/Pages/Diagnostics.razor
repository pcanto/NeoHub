@page "/diagnostics"
@using NeoHub.Services.Diagnostics
@using Microsoft.Extensions.Options
@using System.Text
@using NeoHub.Services.Settings
@inject IDiagnosticsLogService LogService
@inject IOptionsMonitor<DiagnosticsSettings> SettingsMonitor
@inject ISettingsPersistenceService SettingsPersistence
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Diagnostics</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Diagnostics</MudText>

    @* ── Toolbar ── *@
    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudSelect T="LogLevel" 
                       Label="Global Log Level" 
                       Value="settings.MinimumLogLevel"
                       ValueChanged="OnGlobalLogLevelChanged"
                       Variant="Variant.Outlined"
                       Dense="true"
                       Style="max-width: 200px;">
                @foreach (var level in LogLevels)
                {
                    <MudSelectItem T="LogLevel" Value="@level">@level</MudSelectItem>
                }
            </MudSelect>

            <MudSwitch T="bool" 
                       Value="settings.AppOnly"
                       ValueChanged="OnAppOnlyChanged"
                       Label="App only" 
                       Color="Color.Secondary" />

            <MudSwitch T="bool" 
                       @bind-Value="autoScroll" 
                       Label="Auto-scroll" 
                       Color="Color.Primary" />

            <MudSpacer />

            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Secondary" 
                       Size="Size.Small"
                       OnClick="ClearLogs"
                       StartIcon="@Icons.Material.Filled.Clear">
                Clear
            </MudButton>

            <MudButton Variant="Variant.Filled" 
                       Color="Color.Success" 
                       Size="Size.Small"
                       OnClick="DownloadLogs"
                       StartIcon="@Icons.Material.Filled.Download">
                Download
            </MudButton>
        </MudStack>
    </MudPaper>

    @* ── Category Overrides (expandable) ── *@
    <MudExpansionPanels Class="mb-4">
        <MudExpansionPanel Text="Category Filters" MaxHeight="400">
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                Override log levels per category. Categories appear as they are discovered from log output.
            </MudText>
            <MudTable Items="@categoryRows" Dense="true" Hover="true" FixedHeader="true" Height="300px">
                <HeaderContent>
                    <MudTh>Category</MudTh>
                    <MudTh Style="width: 200px;">Level</MudTh>
                    <MudTh Style="width: 80px;"></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        <MudTooltip Text="@context.FullName">
                            <MudText Typo="Typo.body2">@context.ShortName</MudText>
                        </MudTooltip>
                    </MudTd>
                    <MudTd>
                        <MudSelect T="string" 
                                   Value="@context.SelectedLevel"
                                   ValueChanged="@(v => OnCategoryLevelChanged(context, v))"
                                   Dense="true"
                                   Variant="Variant.Text"
                                   Margin="Margin.Dense">
                            <MudSelectItem T="string" Value="@("Global")">
                                Global (@settings.MinimumLogLevel)
                            </MudSelectItem>
                            @foreach (var level in LogLevels)
                            {
                                <MudSelectItem T="string" Value="@level.ToString()">@level</MudSelectItem>
                            }
                        </MudSelect>
                    </MudTd>
                    <MudTd>
                        @if (context.HasOverride)
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.Clear" 
                                           Size="Size.Small" 
                                           OnClick="@(() => RemoveCategoryOverride(context))" />
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudExpansionPanel>
    </MudExpansionPanels>

    @* ── Log Table ── *@
    <MudPaper Class="pa-4" Style="height: 60vh; overflow-y: auto;" id="log-container">
        <MudTable Items="@filteredLogs" 
                  Dense="true" 
                  Hover="true" 
                  FixedHeader="true"
                  Height="100%">
            <HeaderContent>
                <MudTh Style="width: 180px;">Timestamp</MudTh>
                <MudTh Style="width: 100px;">Level</MudTh>
                <MudTh Style="width: 250px;">Category</MudTh>
                <MudTh>Message</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Timestamp">
                    <MudText Typo="Typo.caption">@context.Timestamp.ToLocalTime().ToString("HH:mm:ss.fff")</MudText>
                </MudTd>
                <MudTd DataLabel="Level">
                    <MudChip T="string" 
                             Size="Size.Small" 
                             Color="@GetLogLevelColor(context.LogLevel)">
                        @context.LogLevel
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Category">
                    <MudText Typo="Typo.caption">@GetShortCategory(context.Category)</MudText>
                </MudTd>
                <MudTd DataLabel="Message">
                    <MudText Style="font-family: monospace; white-space: pre-wrap; font-size: 0.85em;">@context.Message</MudText>
                    @if (context.Exception != null)
                    {
                        <MudText Color="Color.Error" Typo="Typo.caption" Style="font-family: monospace; white-space: pre-wrap;">
                            @context.Exception.ToString()
                        </MudText>
                    }
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>

    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
        Showing @filteredLogs.Count of @allLogs.Count total log entries (buffer max: @settings.MaxLogEntries)
    </MudText>
</MudContainer>

@code {
    private static readonly LogLevel[] LogLevels = Enum.GetValues<LogLevel>().Where(l => l != LogLevel.None).ToArray();

    private DiagnosticsSettings settings = new();
    private bool autoScroll = true;
    private List<DiagnosticsLogEntry> allLogs = new();
    private List<DiagnosticsLogEntry> filteredLogs = new();
    private List<CategoryRow> categoryRows = new();

    protected override void OnInitialized()
    {
        settings = CloneSettings(SettingsMonitor.CurrentValue);
        allLogs = LogService.GetLogs().ToList();
        RefreshCategoryRows();
        FilterLogs();
        LogService.LogReceived += OnLogReceived;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (autoScroll)
            await JS.InvokeVoidAsync("scrollToBottom", "log-container");
    }

    private void OnLogReceived(DiagnosticsLogEntry entry)
    {
        InvokeAsync(() =>
        {
            allLogs.Add(entry);

            // Add new category if discovered
            if (!categoryRows.Any(r => r.FullName == entry.Category))
                RefreshCategoryRows();

            filteredLogs.Add(entry);
            StateHasChanged();
        });
    }

    #region Settings Changes (all auto-save)

    private async Task OnGlobalLogLevelChanged(LogLevel level)
    {
        settings.MinimumLogLevel = level;
        FilterLogs();
        await SaveSettingsAsync();
    }

    private async Task OnAppOnlyChanged(bool value)
    {
        settings.AppOnly = value;
        FilterLogs();
        await SaveSettingsAsync();
    }

    private async Task OnCategoryLevelChanged(CategoryRow row, string value)
    {
        if (value == "Global")
        {
            settings.CategoryOverrides.Remove(row.FullName);
            row.SelectedLevel = "Global";
            row.HasOverride = false;
        }
        else
        {
            var level = Enum.Parse<LogLevel>(value);
            settings.CategoryOverrides[row.FullName] = level;
            row.SelectedLevel = value;
            row.HasOverride = true;
        }

        FilterLogs();
        await SaveSettingsAsync();
    }

    private async Task RemoveCategoryOverride(CategoryRow row)
    {
        settings.CategoryOverrides.Remove(row.FullName);
        row.SelectedLevel = "Global";
        row.HasOverride = false;
        FilterLogs();
        await SaveSettingsAsync();
    }

    private async Task SaveSettingsAsync()
    {
        await SettingsPersistence.SaveSettingsAsync(typeof(DiagnosticsSettings), settings);
    }

    #endregion

    #region Filtering & Categories

    private void FilterLogs()
    {
        filteredLogs = allLogs.ToList(); // Show everything the provider captured
    }

    private void RefreshCategoryRows()
    {
        categoryRows = LogService.GetDiscoveredCategories()
            .OrderBy(c => c)
            .Select(c =>
            {
                var hasOverride = settings.CategoryOverrides.TryGetValue(c, out var overrideLevel);
                return new CategoryRow
                {
                    FullName = c,
                    ShortName = GetShortCategory(c),
                    SelectedLevel = hasOverride ? overrideLevel.ToString() : "Global",
                    HasOverride = hasOverride
                };
            })
            .ToList();
    }

    #endregion

    #region Actions

    private void ClearLogs()
    {
        LogService.Clear();
        allLogs.Clear();
        filteredLogs.Clear();
    }

    private async Task DownloadLogs()
    {
        var sb = new StringBuilder();
        sb.AppendLine($"NeoHub Diagnostics Log - Generated {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
        sb.AppendLine(new string('=', 80));
        sb.AppendLine();

        foreach (var entry in filteredLogs)
        {
            sb.AppendLine($"[{entry.Timestamp.ToLocalTime():yyyy-MM-dd HH:mm:ss.fff}] [{entry.LogLevel}] {entry.Category}");
            sb.AppendLine($"  {entry.Message}");
            if (entry.Exception != null)
                sb.AppendLine($"  Exception: {entry.Exception}");
            sb.AppendLine();
        }

        var fileName = $"NeoHub-logs-{DateTime.Now:yyyyMMdd-HHmmss}.txt";
        var bytes = Encoding.UTF8.GetBytes(sb.ToString());
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("downloadFile", fileName, base64);
    }

    #endregion

    #region Helpers

    private static DiagnosticsSettings CloneSettings(DiagnosticsSettings source) => new()
    {
        MinimumLogLevel = source.MinimumLogLevel,
        MaxLogEntries = source.MaxLogEntries,
        AppOnly = source.AppOnly,
        CategoryOverrides = new Dictionary<string, LogLevel>(source.CategoryOverrides)
    };

    private static Color GetLogLevelColor(LogLevel level) => level switch
    {
        LogLevel.Trace => Color.Default,
        LogLevel.Debug => Color.Info,
        LogLevel.Information => Color.Success,
        LogLevel.Warning => Color.Warning,
        LogLevel.Error => Color.Error,
        LogLevel.Critical => Color.Error,
        _ => Color.Default
    };

    private static string GetShortCategory(string category)
    {
        var parts = category.Split('.');
        return parts.Length > 0 ? parts[^1] : category;
    }

    public void Dispose()
    {
        LogService.LogReceived -= OnLogReceived;
    }

    #endregion

    private class CategoryRow
    {
        public required string FullName { get; init; }
        public required string ShortName { get; init; }
        public string SelectedLevel { get; set; } = "Global";
        public bool HasOverride { get; set; }
    }
}