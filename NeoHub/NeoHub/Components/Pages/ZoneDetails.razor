@page "/zones/{SessionId}/{PartitionNumber:int}"
@using NeoHub.Services
@using NeoHub.Services.Models
@inject IPanelStateService PanelState
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Zone Details - Partition @PartitionNumber</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudBreadcrumbs Items="breadcrumbs" Class="mb-4"></MudBreadcrumbs>

    @if (session == null)
    {
        <MudAlert Severity="Severity.Warning">
            Session @SessionId not found
        </MudAlert>
    }
    else if (partition == null)
    {
        <MudAlert Severity="Severity.Warning">
            Partition @PartitionNumber not found
        </MudAlert>
    }
    else
    {
        <MudPaper Class="pa-4 mb-4">
            <MudStack Row="true" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h4">Partition @PartitionNumber</MudText>
                <MudSpacer />
                <MudChip T="string" 
                         Color="@(partition.IsReady ? Color.Success : Color.Warning)" 
                         Size="Size.Medium">
                    @partition.ArmMode
                </MudChip>
            </MudStack>
        </MudPaper>

        <MudText Typo="Typo.h5" Class="mb-3">
            Zones (@zonesForPartition.Count)
        </MudText>

        @if (!zonesForPartition.Any())
        {
            <MudAlert Severity="Severity.Info">
                No zones assigned to this partition
            </MudAlert>
        }
        else
        {
            <MudTable Items="@zonesForPartition" Dense="true" Hover="true" Striped="true">
                <HeaderContent>
                    <MudTh>Zone</MudTh>
                    <MudTh>Name</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>State Flags</MudTh>
                    <MudTh>Other Partitions</MudTh>
                    <MudTh>Last Updated</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Zone">
                        <MudChip T="string" Size="Size.Small">@context.ZoneNumber</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Name">
                        @(string.IsNullOrEmpty(context.ZoneName) ? $"Zone {context.ZoneNumber}" : context.ZoneName)
                    </MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" 
                                 Size="Size.Small" 
                                 Color="@GetZoneColor(context)"
                                 Icon="@GetZoneIcon(context)">
                            @(context.IsOpen ? "OPEN" : "CLOSED")
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="State Flags">
                        <MudStack Row="true" Spacing="1">
                            @if (context.IsFaulted)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Error">FAULTED</MudChip>
                            }
                            @if (context.IsTampered)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Error">TAMPERED</MudChip>
                            }
                            @if (context.IsBypassed)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Info">BYPASSED</MudChip>
                            }
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Other Partitions">
                        @{
                            var otherPartitions = context.Partitions.Where(p => p != PartitionNumber).ToList();
                            if (otherPartitions.Any())
                            {
                                <MudText Typo="Typo.caption">@string.Join(", ", otherPartitions)</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">â€”</MudText>
                            }
                        }
                    </MudTd>
                    <MudTd DataLabel="Last Updated">
                        <MudText Typo="Typo.caption">@context.LastUpdated.ToLocalTime().ToString("HH:mm:ss")</MudText>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    }
</MudContainer>

@code {
    [Parameter]
    public string SessionId { get; set; } = "";

    [Parameter]
    public int PartitionNumber { get; set; }

    private SessionState? session;
    private PartitionState? partition;
    private List<ZoneState> zonesForPartition = new();
    private List<BreadcrumbItem> breadcrumbs = new();

    protected override void OnInitialized()
    {
        breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/"),
            new BreadcrumbItem($"Session: {SessionId}", href: null, disabled: true),
            new BreadcrumbItem($"Partition {PartitionNumber}", href: null, disabled: true)
        };

        LoadData();
        PanelState.PartitionStateChanged += OnStateChanged;
        PanelState.ZoneStateChanged += OnStateChanged;
    }

    private void LoadData()
    {
        session = PanelState.GetSession(SessionId);
        partition = PanelState.GetPartition(SessionId, (byte)PartitionNumber);

        if (session != null)
        {
            // Get all zones that belong to this partition
            zonesForPartition = session.Zones.Values
                .Where(z => z.Partitions.Contains((byte)PartitionNumber))
                .OrderBy(z => z.ZoneNumber)
                .ToList();
        }
    }

    private void OnStateChanged(object? sender, EventArgs e)
    {
        InvokeAsync(() =>
        {
            LoadData();
            StateHasChanged();
        });
    }

    private Color GetZoneColor(ZoneState zone)
    {
        if (zone.IsTampered) return Color.Error;
        if (zone.IsFaulted) return Color.Error;
        if (zone.IsOpen) return Color.Warning;
        if (zone.IsBypassed) return Color.Info;
        return Color.Success;
    }

    private string GetZoneIcon(ZoneState zone)
    {
        if (zone.IsTampered) return Icons.Material.Filled.Error;
        if (zone.IsFaulted) return Icons.Material.Filled.Warning;
        if (zone.IsOpen) return Icons.Material.Filled.LockOpen;
        if (zone.IsBypassed) return Icons.Material.Filled.Block;
        return Icons.Material.Filled.Lock;
    }

    public void Dispose()
    {
        PanelState.PartitionStateChanged -= OnStateChanged;
        PanelState.ZoneStateChanged -= OnStateChanged;
    }
}